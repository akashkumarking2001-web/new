import{r as _,j as t,u as w,a as j}from"./index-CuoSW9a6.js";import{u as g}from"./useQuery-1-ZV3XJR.js";function S({value:e,onChange:s,placeholder:l="Search...",debounceMs:c=300,className:r,inputClassName:u}){const[n,m]=_.useState(e??""),p=_.useRef(null);_.useEffect(()=>{e!==void 0&&m(e)},[e]);const d=_.useCallback(h=>{p.current&&clearTimeout(p.current),p.current=setTimeout(()=>s(h),c)},[s,c]);_.useEffect(()=>()=>{p.current&&clearTimeout(p.current)},[]);function v(h){const i=h.target.value;m(i),d(i)}function x(){m(""),p.current&&clearTimeout(p.current),s("")}return t.jsxs("div",{className:r,style:{position:"relative",display:"flex",alignItems:"center"},children:[t.jsx("input",{type:"text",value:n,onChange:v,placeholder:l,className:u,style:u?void 0:{width:"100%",padding:"8px 32px 8px 12px",background:"var(--bg-primary, #0a0a1a)",border:"1px solid var(--border-subtle, rgba(255,255,255,0.06))",borderRadius:"6px",color:"var(--text-primary, #e0e0ff)",fontSize:"0.85rem",fontFamily:"var(--font-mono, monospace)",outline:"none"}}),n&&t.jsx("button",{onClick:x,"aria-label":"Clear search",style:{position:"absolute",right:"8px",background:"none",border:"none",color:"var(--text-secondary, #8888aa)",cursor:"pointer",fontSize:"0.9rem",padding:"2px 4px",lineHeight:1},children:"x"})]})}function B({tabs:e,activeTab:s,onTabChange:l,containerClassName:c,panelClassName:r,tabListClassName:u,tabClassName:n,activeTabClassName:m}){return t.jsxs("div",{className:c,children:[t.jsx("div",{role:"tablist",className:u,style:u?void 0:{display:"flex",gap:"2px",borderBottom:"1px solid var(--border-subtle, rgba(255,255,255,0.06))",marginBottom:"12px"},children:e.map(p=>{const d=s===p.id,v=[n,d&&m].filter(Boolean).join(" ");return t.jsx("button",{role:"tab","aria-selected":d,onClick:()=>l(p.id),className:v||void 0,style:v?void 0:{padding:"8px 16px",background:d?"var(--bg-accent, rgba(0,229,255,0.1))":"transparent",border:"none",borderBottom:d?"2px solid var(--accent-cyan, #00e5ff)":"2px solid transparent",color:d?"var(--accent-cyan, #00e5ff)":"var(--text-secondary, #8888aa)",cursor:"pointer",fontSize:"0.85rem",fontFamily:"var(--font-mono, monospace)",transition:"color 0.15s, background 0.15s"},children:p.label},p.id)})}),t.jsx("div",{role:"tabpanel",className:r,children:e.find(p=>p.id===s)?.content})]})}const C="_container_ip9o0_5",E="_filters_ip9o0_15",D="_filterGroup_ip9o0_22",k="_filterLabel_ip9o0_28",F="_filterSelect_ip9o0_35",$="_filterInput_ip9o0_36",P="_sortToggle_ip9o0_52",q="_results_ip9o0_70",L="_emptyState_ip9o0_78",M="_row_ip9o0_87",I="_rowTitle_ip9o0_105",R="_rowProject_ip9o0_113",A="_rowDate_ip9o0_121",H="_rowDuration_ip9o0_127",G="_rowStatus_ip9o0_133",U="_rowMeta_ip9o0_163",O="_deleteBtn_ip9o0_169",z="_pagination_ip9o0_187",K="_pageBtn_ip9o0_195",Q="_pageBtnActive_ip9o0_216",W="_pageEllipsis_ip9o0_222",Z="_detailOverlay_ip9o0_229",J="_detailCard_ip9o0_239",V="_detailTabs_ip9o0_253",X="_detailTabPanel_ip9o0_261",Y="_detailHeader_ip9o0_269",tt="_detailTitle_ip9o0_276",et="_detailMeta_ip9o0_282",at="_detailCloseBtn_ip9o0_289",st="_detailBody_ip9o0_302",ot="_convoEntry_ip9o0_307",it="_convoEntryHeader_ip9o0_315",nt="_copyBtn_ip9o0_322",rt="_convoPrompt_ip9o0_344",lt="_convoResponse_ip9o0_349",ct="_convoTime_ip9o0_354",dt="_convoText_ip9o0_360",pt="_activityEntry_ip9o0_367",ut="_activityTime_ip9o0_375",mt="_activityBadge_ip9o0_381",_t="_activityBadgeTool_ip9o0_390",vt="_activityBadgeEvent_ip9o0_395",ht="_activityDetail_ip9o0_400",a={container:C,filters:E,filterGroup:D,filterLabel:k,filterSelect:F,filterInput:$,sortToggle:P,results:q,emptyState:L,row:M,rowTitle:I,rowProject:R,rowDate:A,rowDuration:H,rowStatus:G,rowMeta:U,deleteBtn:O,pagination:z,pageBtn:K,pageBtnActive:Q,pageEllipsis:W,detailOverlay:Z,detailCard:J,detailTabs:V,detailTabPanel:X,detailHeader:Y,detailTitle:tt,detailMeta:et,detailCloseBtn:at,detailBody:st,convoEntry:ot,convoEntryHeader:it,copyBtn:nt,convoPrompt:rt,convoResponse:lt,convoTime:ct,convoText:dt,activityEntry:pt,activityTime:ut,activityBadge:mt,activityBadgeTool:_t,activityBadgeEvent:vt,activityDetail:ht},N=50;function f(e){if(e<1e3)return"<1s";const s=Math.floor(e/1e3);if(s<60)return`${s}s`;const l=Math.floor(s/60);return l<60?`${l}m ${s%60}s`:`${Math.floor(l/60)}h ${l%60}m`}function xt(e){return e?new Date(e).toLocaleString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",hour12:!1}):"--"}function b(e){return new Date(e).toLocaleTimeString("en-US",{hour12:!1})}function yt(e){const s=new URLSearchParams;e.query&&s.set("query",e.query),e.project&&s.set("project",e.project),e.status==="archived"?s.set("archived","true"):e.status&&s.set("status",e.status),e.dateFrom&&s.set("dateFrom",String(new Date(e.dateFrom).getTime())),e.dateTo&&s.set("dateTo",String(new Date(e.dateTo+"T23:59:59").getTime()));const l={date:"started_at",duration:"last_activity_at",prompts:"started_at",tools:"started_at"};return s.set("sortBy",l[e.sortBy]||"started_at"),s.set("sortDir",e.sortDir),s.set("page",String(e.page)),s.set("pageSize",String(N)),s.toString()}function wt(){const e=w(),[s,l]=_.useState({query:"",project:"",status:"",dateFrom:"",dateTo:"",sortBy:"date",sortDir:"desc",page:1}),[c,r]=_.useState(null),{data:u}=g({queryKey:["db-projects"],queryFn:async()=>{const o=await j("/api/db/projects");if(!o.ok)throw new Error("Failed to load projects");return o.json()},staleTime:6e4}),{data:n,isLoading:m}=g({queryKey:["db-sessions",s],queryFn:async()=>{const o=await j(`/api/db/sessions?${yt(s)}`);if(!o.ok)throw new Error("Failed to load sessions");return o.json()}}),{data:p}=g({queryKey:["db-session-detail",c],queryFn:async()=>{if(!c)return null;const o=await j(`/api/db/sessions/${encodeURIComponent(c)}`);if(!o.ok)throw new Error("Failed to load session detail");return o.json()},enabled:!!c}),d=_.useCallback((o,y)=>{l(T=>({...T,[o]:y,page:o==="page"?y:1}))},[]),v=_.useCallback(async(o,y)=>{o.stopPropagation(),window.confirm("Delete this session from history? This cannot be undone.")&&(await j(`/api/db/sessions/${encodeURIComponent(y)}`,{method:"DELETE"}),e.invalidateQueries({queryKey:["db-sessions"]}))},[e]),x=n?.sessions??[],h=n?.total??0,i=Math.ceil(h/N);return t.jsxs("div",{className:a.container,"data-testid":"history-view",children:[t.jsxs("div",{className:a.filters,children:[t.jsx(S,{value:s.query,onChange:o=>d("query",o),placeholder:"Search prompts..."}),t.jsxs("div",{className:a.filterGroup,children:[t.jsx("span",{className:a.filterLabel,children:"Project"}),t.jsxs("select",{className:a.filterSelect,value:s.project,onChange:o=>d("project",o.target.value),children:[t.jsx("option",{value:"",children:"All"}),u?.map(o=>t.jsx("option",{value:o.project_path,children:o.project_name},o.project_path))]})]}),t.jsxs("div",{className:a.filterGroup,children:[t.jsx("span",{className:a.filterLabel,children:"Status"}),t.jsxs("select",{className:a.filterSelect,value:s.status,onChange:o=>d("status",o.target.value),children:[t.jsx("option",{value:"",children:"All"}),t.jsx("option",{value:"idle",children:"Idle"}),t.jsx("option",{value:"working",children:"Working"}),t.jsx("option",{value:"waiting",children:"Waiting"}),t.jsx("option",{value:"ended",children:"Ended"}),t.jsx("option",{value:"archived",children:"Archived"})]})]}),t.jsxs("div",{className:a.filterGroup,children:[t.jsx("span",{className:a.filterLabel,children:"From"}),t.jsx("input",{type:"date",className:a.filterInput,value:s.dateFrom,onChange:o=>d("dateFrom",o.target.value)})]}),t.jsxs("div",{className:a.filterGroup,children:[t.jsx("span",{className:a.filterLabel,children:"To"}),t.jsx("input",{type:"date",className:a.filterInput,value:s.dateTo,onChange:o=>d("dateTo",o.target.value)})]}),t.jsxs("div",{className:a.filterGroup,children:[t.jsx("span",{className:a.filterLabel,children:"Sort"}),t.jsxs("select",{className:a.filterSelect,value:s.sortBy,onChange:o=>d("sortBy",o.target.value),children:[t.jsx("option",{value:"date",children:"Date"}),t.jsx("option",{value:"duration",children:"Activity"}),t.jsx("option",{value:"prompts",children:"Prompts"}),t.jsx("option",{value:"tools",children:"Tools"})]}),t.jsx("button",{className:a.sortToggle,onClick:()=>d("sortDir",s.sortDir==="desc"?"asc":"desc"),children:s.sortDir.toUpperCase()})]})]}),t.jsxs("div",{className:a.results,children:[m&&t.jsx("div",{className:a.emptyState,children:"Loading..."}),!m&&x.length===0&&t.jsx("div",{className:a.emptyState,children:"No sessions found"}),x.map(o=>t.jsx(jt,{session:o,onClick:()=>r(o.id),onDelete:y=>v(y,o.id)},o.id))]}),i>1&&t.jsx(ft,{currentPage:s.page,totalPages:i,onPageChange:o=>d("page",o)}),c&&p&&t.jsx(bt,{detail:p,onClose:()=>r(null)})]})}function jt({session:e,onClick:s,onDelete:l}){const c=e.ended_at&&e.started_at?f(e.ended_at-e.started_at):e.started_at?f(Date.now()-e.started_at):"--";return t.jsxs("div",{className:a.row,onClick:s,children:[t.jsx("span",{className:a.rowTitle,children:e.title||e.project_name||e.id}),t.jsx("span",{className:a.rowProject,children:e.project_name}),t.jsx("span",{className:a.rowDate,children:xt(e.started_at)}),t.jsx("span",{className:a.rowDuration,children:c}),t.jsx("span",{className:a.rowStatus,"data-status":e.status,children:e.status.toUpperCase()}),t.jsxs("span",{className:a.rowMeta,children:[e.total_prompts," prompts"]}),t.jsxs("span",{className:a.rowMeta,children:[e.total_tool_calls," tools"]}),t.jsx("button",{className:a.deleteBtn,onClick:l,title:"Delete session","aria-label":"Delete session",children:"x"})]})}function ft({currentPage:e,totalPages:s,onPageChange:l}){const c=[];for(let n=1;n<=s;n++)(n===1||n===s||n>=e-2&&n<=e+2)&&c.push(n);const r=[];let u=0;for(const n of c)typeof n=="number"&&(u&&n-u>1&&r.push("ellipsis"),r.push(n),u=n);return t.jsxs("div",{className:a.pagination,children:[t.jsx("button",{className:a.pageBtn,disabled:e<=1,onClick:()=>l(e-1),children:"Prev"}),r.map((n,m)=>n==="ellipsis"?t.jsx("span",{className:a.pageEllipsis,children:"..."},`e-${m}`):t.jsx("button",{className:`${a.pageBtn} ${n===e?a.pageBtnActive:""}`,onClick:()=>l(n),children:n},n)),t.jsx("button",{className:a.pageBtn,disabled:e>=s,onClick:()=>l(e+1),children:"Next"})]})}function gt({text:e}){const[s,l]=_.useState(!1),c=r=>{r.stopPropagation(),navigator.clipboard.writeText(e).then(()=>{l(!0),setTimeout(()=>l(!1),1500)})};return t.jsx("button",{className:a.copyBtn,onClick:c,"aria-label":"Copy to clipboard",title:"Copy to clipboard",children:s?"✓":"⎘"})}function bt({detail:e,onClose:s}){const[l,c]=_.useState("conversation"),{session:r,prompts:u,responses:n,tool_calls:m,events:p}=e,d=[...u.map(i=>({type:"prompt",timestamp:i.timestamp,text:i.text})),...n.map(i=>({type:"response",timestamp:i.timestamp,text:i.text_excerpt}))].sort((i,o)=>i.timestamp-o.timestamp),v=[...m.map(i=>({kind:"tool",label:i.tool_name,detail:i.tool_input_summary,timestamp:i.timestamp})),...p.map(i=>({kind:"event",label:i.event_type,detail:i.detail,timestamp:i.timestamp}))].sort((i,o)=>o.timestamp-i.timestamp),x=r.ended_at&&r.started_at?f(r.ended_at-r.started_at):r.started_at?f(Date.now()-r.started_at):"--",h=[{id:"conversation",label:`Conversation (${d.length})`,content:t.jsxs("div",{className:a.detailBody,children:[d.length===0&&t.jsx("div",{className:a.emptyState,children:"No conversation recorded"}),d.map((i,o)=>t.jsxs("div",{className:`${a.convoEntry} ${i.type==="prompt"?a.convoPrompt:a.convoResponse}`,children:[t.jsxs("div",{className:a.convoEntryHeader,children:[t.jsx("div",{className:a.convoTime,children:b(i.timestamp)}),t.jsx(gt,{text:i.text})]}),t.jsx("div",{className:a.convoText,children:i.text})]},o))]})},{id:"activity",label:`Activity (${v.length})`,content:t.jsxs("div",{className:a.detailBody,children:[v.length===0&&t.jsx("div",{className:a.emptyState,children:"No activity recorded"}),v.map((i,o)=>t.jsxs("div",{className:a.activityEntry,children:[t.jsx("span",{className:a.activityTime,children:b(i.timestamp)}),t.jsx("span",{className:`${a.activityBadge} ${i.kind==="tool"?a.activityBadgeTool:a.activityBadgeEvent}`,children:i.label}),t.jsx("span",{className:a.activityDetail,children:i.detail})]},o))]})}];return t.jsx("div",{className:a.detailOverlay,onClick:s,children:t.jsxs("div",{className:a.detailCard,onClick:i=>i.stopPropagation(),children:[t.jsxs("div",{className:a.detailHeader,children:[t.jsxs("div",{children:[t.jsx("h2",{className:a.detailTitle,children:r.project_name||r.id}),t.jsxs("div",{className:a.detailMeta,children:[t.jsxs("span",{children:["Status: ",r.status.toUpperCase()]}),t.jsxs("span",{children:["Model: ",r.model||"--"]}),t.jsxs("span",{children:["Duration: ",x]}),t.jsxs("span",{children:[r.total_prompts," prompts / ",r.total_tool_calls," tools"]})]})]}),t.jsx("button",{className:a.detailCloseBtn,onClick:s,"aria-label":"Close",children:"x"})]}),t.jsx(B,{tabs:h,activeTab:l,onTabChange:c,containerClassName:a.detailTabs,panelClassName:a.detailTabPanel})]})})}export{wt as default};
